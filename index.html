<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Thargoid Link Message Decoder</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery.json-viewer.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/site.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="jquery.json-viewer.js"></script>
    <link href="css/jquery.json-viewer.css" type="text/css" rel="stylesheet" />
    
    <script src="pretty-print-json.js"></script>
    <link href="css/pretty-print-json.css" type="text/css" rel="stylesheet" />
  </head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-102148507-4"></script>
 	
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-102148507-4');
</script>  

  <body>

    <h1 class="text-center canonn-heading">Thargoid Link Message Decoder</h1>

    <div class="container">

      <div class="panel">
        
                <div class="row">
          <div class="col-12">
            <p>
    
<script>

/**
 * Get the URL parameters
 * source: https://css-tricks.com/snippets/javascript/get-url-variables/
 * @param  {String} url The URL
 * @return {Object}     The URL parameters
 */
var getParams = function (url) {
	var params = {};
	var parser = document.createElement('a');
	parser.href = url;
	var query = parser.search.substring(1);
	var vars = query.split('&');
	for (var i = 0; i < vars.length; i++) {
		var pair = vars[i].split('=');
		params[pair[0]] = decodeURIComponent(pair[1]);
	}
	return params;
};

var params=getParams(window.location.href);


$( document ).ready(function() {

    if ( params.origin && params.data ) {
      //$(#form).submitForm();
      
      var origin=decodeURIComponent(params.origin).replace(/\+/g," ")
      var data=decodeURIComponent(params.data).replace(/\+/g," ")
      console.log(origin);
      console.log(data)
      doDecode(origin,data);
      $('input:text').val(origin);
      $("#data").val(data);
    }
   
});


function updateScreen(json){
    console.log(json.result);
    $("#result").text(json.Result.name);
    $("#result").html('<div id="result"><p>Result: '+json.Result.name+' '+json.Result.result+'</p><blockquote class="edsm-embed" lang="en" data-value="'+json.Result.name+'"><a href="https://www.edsm.net/" target="_blank">EDSM - Elite Dangerous Star Map</a></blockquote></div>');
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://www.edsm.net/js/embed.js"; 
    document.getElementsByTagName("head")[0].appendChild(script);

    
    $('#json-renderer').html(prettyPrintJson.toHtml(json));
    
}

function doDecode(origin,data){
    $("#result").text("Searching")
    console.log(encodeURI('https://us-central1-canonn-api-236217.cloudfunctions.net/linkDecode?origin='+origin+'&message='+data))
    console.log("ping");
    fetch(encodeURI('https://us-central1-canonn-api-236217.cloudfunctions.net/linkDecode?origin='+origin+'&message='+data))
    .then(response => response.json())
    .then(json => updateScreen(json))
;
}

function submitform(){
    var data = $(this).serializeArray();
    doDecode($('input:text').val(),$("#data").val());
    return false;
};

</script>
   <form id="form" onsubmit="return submitform();">
        <table>
            <tr>
                <td class="label"><label for="origin">Origin:</label></td>
                <td><input type="text" placeholder="Name of the system that yielded the audio used to trigger the UL" name="origin" id="origin" ></td>
            </tr>
            <tr>
                <td class="label"><label for="data">Decoded:</label></td>
                <td><textarea id="data" placeholder="Transcribe the binary transmission, for example:&#10;&#10;010 011 101 | 001 111 101 000&#10;011 111 | 001 111 101 000&#10;011 000 | 011001&#10;&#10;010 010 | 001 111 101&#10;011 111 | 001 111 101 000&#10;010 111 101 | 011 001 000&#10;&#10;010 010 111 | 001 111 101 000&#10;001 | 011 001&#10;001 110 101 001 | 001 111 101 000&#10;&#10;You can use either '010 100' or 'lhl lhh' syntax."
                        name="data" id="data"></textarea></td>
            </tr>
        </table>
        <div id="search-container">
            <input type="submit" value="Search"/>
        </div>

    </form>
<div id="result">&nbsp;</div>
<pre id="json-renderer"></pre>

            </p>
    <div class="row">
          <div class="col-12">            
            <p>
            The thargoid link message is a puzzle that provides us with the distances of an unknown system relative to three known systems. By a process of triangulation we are able to identify a pair of 3D coordinates one of which is the location of the unknown system. 
            </p><p>
            However the link messages are calculated with a precision of three decimal places which means that the distances are not accurate enough to give us the precise location so we must search through a list of known stars to identify stars that are close to the calculated coordinates. Each candidate system has a error value measured in light years.
            </p>
            <p>
            Once we have a list of candidate systems, we can run the calculation is reverse to give us the distances using the same precision used by the Thargoids to calculate their message. If we have identified the correct system then the recalculated distances will match the distances given in the message. We use the recalulated distances to generate a pair of coordinates and then compare these to the original decoded coordinates to give us a control value measured in ly. An exact match on the system would have a control value of exctly 0ly. 
            </p>
            <p>
            We also check to see if any of the recalculated distances match the original distances and this gives us a match value between 1 and 3. If we get a control value or zero and match value of 3 then we can be certain that we have the correct coordinates.
            </p>
            <p>
            </p>
          </div>
        </div>
              
      </div>

    </div><!-- /.container -->




    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>

    <script src="bootstrap/js/bootstrap.min.js"></script>

 
  </body>
</html>
